<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunny.mappers.Delivery_Mapper">
	<!-- 주문 리스트 (검색조건 포함) -->
	<select id="deliveryList" parameterType="SearchCriteria" resultType="DeliveryReadVO">
	 	select ord_no,delivery_check,ord_pay,ord_name,ord_phone,ord_date,
	 	ord_zipcode,ord_add,ord_add_d,
	 	ord_total_price,ord_total_amount,delivery_date
	 	from (select o.ord_no,d.delivery_check,d.ord_pay,o.ord_name,o.ord_phone,o.ord_date,
	 	o.ord_zipcode,o.ord_add,o.ord_add_d,
	 	o.ord_total_price,o.ord_total_amount,d.delivery_date,row_number() over( order by o.ord_no desc)delivery_seq
	 	from delivery d
        inner join order_tbl o
	 	on o.ord_no = d.ord_no
        <include refid="search"/>)
        where delivery_seq between #{rowStart} and #{rowEnd} 
	</select>
	<!-- 주문 총 갯수 -->
	<select id="countTotalOrderAmount" resultType="int">
	 	select sum(ord_amount) 
	 	from order_detail 
	 	where ord_no=#{ord_no} 
	</select>
	<!-- 주문 번호 -->
	<select id="readOrd_No" resultType="int">
		select ord_no from order_tbl
	</select>
	<!-- 주문 총 갯수 -->
	<select id="deliveryCount" parameterType="SearchCriteria" resultType="int">
	 	select count(ord_no) from order_tbl
	    <include refid="search"/>
	</select>
	<!-- 배송 상태 업데이트 -->
	<update id="deliveryCheck" parameterType="Map">
		update delivery set
		delivery_check=#{delivery_check}
		where ord_no=#{ord_no}
	</update>
	<!-- 배송 날짜 업데이트 -->
	<update id="deliveryDate" parameterType="int">
		update delivery set
		delivery_date=sysdate
		where ord_no=#{ord_no}
	</update>
	<!-- 배송 정보 조회 -->
	<sql id="search">
		<if test="searchType != null">
			<if test="searchType =='name'.toString()">
				where ord_name like '%' || #{keyword} || '%'
			</if>
			<if test="searchType == 'phone'.toString()">
				where ord_phone like '%' || #{keyword} || '%'
			</if>
			<if test="searchType =='add'.toString()">
				where ord_add like '%' || #{keyword} || '%'
			</if>
		</if>
	</sql>
	
</mapper>