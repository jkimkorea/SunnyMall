<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunny.mappers.Order_Mapper">
	<!-- 주문 목록 -->
	<select id="readOrderList" parameterType="String" resultType="OrderListVO">
		select p.prd_img,p.prd_name,p.prd_discount,o.ord_no,p.prd_no,d.ord_amount,d.ord_price,o.ord_date
		from order_tbl o
		inner join order_detail d 
			on d.ord_no = o.ord_no
		inner join product p
			on p.prd_no = d.prd_no
		where o.mb_id=#{mb_id}
		order by d.ord_no desc, d.prd_no desc
	</select>
	<!-- 주문 번호 가져오기 -->
	<select id="readOrderNo" resultType="int">
		select ord_seq.nextval from dual
	</select>
	<!-- 주문정보 추가 -->
	<insert id="addOrder">
		insert into order_tbl
		(ord_no,mb_id,ord_name,ord_zipcode,ord_add,ord_add_d,ord_phone,ord_total_price,ord_date)
		values
		(#{ord_no},#{mb_id},#{ord_name},#{ord_zipcode},#{ord_add},#{ord_add_d},#{ord_phone},#{ord_total_price},sysdate)
	</insert>
	<!-- 배송 내역에 정보 추가 -->
	<insert id="addToDelivery" parameterType="int">
	 	insert into delivery(ord_no,delivery_check,ord_pay)
	 	values(#{ord_no},'배송 준비중','y')
	</insert>
	<!-- 주문 내역 추가 -->
	<insert id="addOrderDetail" parameterType="OrderDetailVO">
		insert into order_detail(ord_no,prd_no,ord_amount,ord_price)
		values(#{ord_no},#{prd_no},#{ord_amount},#{ord_price})
	</insert>
	<!-- 주문 상세 정보 -->
	<select id="readOrder" parameterType="int" resultType="OrderReadDetailVO">
		select d.ord_amount, d.prd_no, d.ord_price, 
		p.prd_name, p.prd_img, p.prd_price,p.prd_discount
		from order_detail d
		inner join product p
			on d.prd_no=p.prd_no
		where d.ord_no=#{ord_no}
	</select>
	<!-- 주문자 정보 -->
	<select id="getOrder" parameterType="int" resultType="OrderVO" >
		select ord_no, mb_id, ord_name, ord_zipcode, ord_add, ord_add_d, ord_phone, ord_total_price,ord_date
		from order_tbl
		where ord_no=#{ord_no}
	</select>
	<select id="readCartAmount" parameterType="int" resultType="int">
		select cart_amount from cart where cart_code=#{cart_code}
	</select>
	<!-- 주문 총 수량 저장 -->
	<update id="addTotalAmount" parameterType="int">
		update order_tbl
		set
		ord_total_amount=
		(select sum(ord_amount) from order_detail where ord_no = #{ord_no})
		where ord_no = #{ord_no}
	</update>
</mapper>